# File Processing System

This directory contains the file processing system for the MOSAIC platform. The file processing system allows users to upload files and have them processed by specialized agents.

## Components

The file processing system consists of two main components:

### FileProcessingAgent

The `FileProcessingAgent` is a specialized agent that processes uploaded files. It currently focuses on Excel (XLSX) files, extracting and analyzing tabular data. The agent is defined in `file_processing.py`.

#### Tools

The `FileProcessingAgent` provides the following tools:

- **process_excel_file_tool**: Extracts basic information and preview data from Excel files
  - Reads the Excel file and extracts basic information (rows, columns, column names)
  - Generates a preview of the data as a markdown table
  - Calculates summary statistics for numeric columns
  - Identifies most common values for string columns

- **analyze_excel_data_tool**: Performs specific analyses on Excel data
  - **correlation**: Calculates correlation matrix for numeric columns and identifies strong correlations
  - **summary**: Generates summary statistics for all columns
  - **groupby**: Groups data by a categorical column and calculates statistics for numeric columns

#### File Handling

The `FileProcessingAgent` is designed to handle file attachments in several ways:

1. **Direct Processing**: If the file data is provided directly as base64-encoded data, the agent will decode and process it.

2. **Database Retrieval**: If the file data is not provided directly, the agent will attempt to retrieve it from the database:
   - It will search for attachments with the same file name
   - It will retrieve the most recent attachment with that name
   - It will extract the binary data and convert it to base64 for processing

3. **Error Recovery**: If there are issues with the base64 data, the agent will attempt to fix common problems:
   - Adding padding characters if needed
   - Replacing spaces with plus signs
   - Removing newlines and carriage returns

This robust approach ensures that files can be processed even if there are issues with the data transfer between agents.

### FileProcessingSupervisor

The `FileProcessingSupervisor` is a supervisor agent that orchestrates file processing. It determines the file type and routes processing to specialized agents like the `FileProcessingAgent`. The supervisor is defined in `supervisors/file_processing_supervisor.py`.

#### Tools

The supervisor provides the following tools (automatically generated by the LangGraph framework):

- **transfer_to_file_processing**: Transfers control to the `FileProcessingAgent` for processing Excel files
- **transfer_back_to_file_processing_supervisor**: Transfers control back to the supervisor after processing

#### File Type Detection

The supervisor detects file types based on:
- File extension (e.g., .xlsx, .csv)
- MIME type (e.g., application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)
- Content indicators in the message (e.g., "[Attached Excel file:")

Based on the detected file type, the supervisor routes the processing to the appropriate specialized agent.

## File Processing Flow

The file processing flow works as follows:

1. **File Upload**: The user uploads a file through the chat interface
2. **Storage**: The file is stored in the database as an attachment
3. **Message Routing**: The message with the attachment is sent to the `file_processing_supervisor` agent
4. **File Type Detection**: The supervisor detects the file type and transfers control to the appropriate specialized agent
5. **File Retrieval**: The specialized agent retrieves the file data from the database
6. **Processing**: The agent processes the file using the appropriate tools
7. **Result Return**: The agent returns the results to the supervisor
8. **Response**: The supervisor includes the full results in its response to the user

This architecture allows for easy extension to support additional file types in the future.

## Implementation Details

### Database Integration

The file processing system integrates with the MOSAIC database system to store and retrieve file attachments:

- **AttachmentModel**: Represents a file attachment in the database
- **AttachmentRepository**: Provides methods for storing and retrieving attachments
- **get_db_session**: Creates a database session for querying attachments

### Error Handling

The file processing system includes robust error handling to deal with various issues that may arise during file processing:

- **Base64 Decoding Errors**: The system attempts to fix common issues with base64-encoded data
- **File Format Errors**: The system provides clear error messages if the file format is not supported
- **Database Errors**: The system logs detailed information about database errors
- **Processing Errors**: The system catches and logs exceptions during file processing

### Logging

The file processing system includes detailed logging to help diagnose issues:

- **File Information**: Logs information about the file being processed (name, size, type)
- **Processing Steps**: Logs each step of the file processing flow
- **Error Details**: Logs detailed information about errors that occur during processing
- **Result Summary**: Logs a summary of the processing results

## Adding Support for New File Types

To add support for a new file type:

1. **Create a New Agent**: Create a new specialized agent that handles the file type (e.g., `PDFProcessingAgent`)
2. **Implement Tools**: Implement tools for processing the file type (e.g., `process_pdf_file_tool`)
3. **Update Supervisor**: Update the `file_processing_supervisor` to detect the file type and transfer control to the new agent
4. **Register Agent**: Register the new agent with the agent registry

The modular design of the file processing system makes it easy to extend with support for additional file types while maintaining a consistent user experience.

## Example Usage

To process an Excel file:

1. Upload an Excel file through the chat interface
2. The file will be automatically processed by the `file_processing` agent
3. The agent will extract basic information and preview data from the file
4. The results will be displayed in the chat interface

To perform specific analyses on an Excel file:

1. Upload an Excel file through the chat interface
2. Ask for a specific analysis (e.g., "Can you show me the correlation matrix for this data?")
3. The `file_processing` agent will perform the requested analysis
4. The results will be displayed in the chat interface

## Future Enhancements

Planned enhancements for the file processing system include:

- **PDF Processing**: Add support for processing PDF files
- **Image Processing**: Add support for processing image files
- **Audio/Video Processing**: Add support for processing audio and video files
- **Advanced Visualization**: Add support for generating visualizations from data
- **Multi-File Processing**: Add support for processing multiple files at once
- **File Comparison**: Add support for comparing multiple files
